name: Notify Telegram on push

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  notify:
    name: Send Telegram notification
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Prepare short message (shell)
        continue-on-error: true
        run: |
          set +e
          # Extract first-line commit message
          message="$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH" | head -n1)"
          # Extract author (fallback to actor)
          author="$(jq -r '.head_commit.author.name // empty' "$GITHUB_EVENT_PATH")"
          if [ -z "$author" ] || [ "$author" = "null" ]; then
            author="$GITHUB_ACTOR"
          fi
          # Escape HTML special chars
          message="${message//&/&amp;}"
          message="${message//</&lt;}"
          message="${message//>/&gt;}"
          author="${author//&/&amp;}"
          author="${author//</&lt;}"
          author="${author//>/&gt;}"
          # Truncate to 80 chars
          max=80
          if [ ${#message} -gt $max ]; then
            message="${message:0:$((max-1))}…"
          fi
          sha="${GITHUB_SHA:0:7}"
          url="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          # Use only repo name (drop org)
          REPO="${GITHUB_REPOSITORY##*/}"
          # Format: [repo] message — author (link with short sha)
          printf '[%s] %s — %s <a href="%s">(%s)</a>\n' "$REPO" "$message" "$author" "$url" "$sha" > telegram_message.txt
      - name: Send Telegram message
        continue-on-error: true
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_TO }}
          TG_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          set +e
          api="https://api.telegram.org/bot${TG_TOKEN}/sendMessage"
          extra=""
          if [ -n "$TG_TOPIC_ID" ]; then
            extra="-d message_thread_id=${TG_TOPIC_ID}"
          fi
          curl -sS -X POST "$api" \
            -d "chat_id=${TG_CHAT_ID}" \
            --data-urlencode "text=$(cat telegram_message.txt)" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true" \
            $extra \
            | jq -r 'select(.ok==false) | .description' && exit 1 || true
